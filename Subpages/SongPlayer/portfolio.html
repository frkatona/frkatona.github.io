<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Music Portfolio</title>
    <style>
        :root{
            --bg: #0b0b0c; --panel: #121214; --muted:#8a8a92; --fg:#f3f3f4; --line:#232327; --accent:#63e; --accent2:#21d4b6;
            --radius: 16px; --radius-sm: 10px; --shadow: 0 10px 30px rgba(0,0,0,.35)
        }
        *{box-sizing:border-box}
        html,body{height:100%} 
        body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,Apple Color Emoji,Segoe UI Emoji;
            color:var(--fg);background:radial-gradient(1200px 800px at 10% -10%, rgba(99,51,238,.25), transparent 40%),
            radial-gradient(800px 600px at 110% 110%, rgba(33,212,182,.20), transparent 50%), var(--bg)}

        .wrap{max-width:1200px;margin:0 auto;padding:20px}
        header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);background:linear-gradient(to bottom, rgba(11,11,12,.8), rgba(11,11,12,.3));border-bottom:1px solid var(--line)}
        header .bar{display:flex;align-items:center;gap:12px;padding:12px 20px}
        .logo{width:34px;height:34px;border-radius:20px;background:conic-gradient(from 180deg, rgba(213, 85, 11, 1),  rgba(78, 76, 32, 1),#a0f);box-shadow:inset 0 0 20px rgba(57, 229, 255, 0.7)}
        .spacer{flex:1}
        button, .btn{appearance:none;border:1px solid var(--line);background:#151519;color:var(--fg);padding:8px 12px;border-radius:999px;cursor:pointer}
        button:hover,.btn:hover{background:#1b1b21}

        main{display:grid;grid-template-columns:320px 1fr;gap:20px;padding:20px}
        @media (max-width: 900px){main{grid-template-columns:1fr}}

        .card{background:linear-gradient(180deg, #121214, #101013);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
        .pad{padding:16px}
        .title{font-weight:600;letter-spacing:.2px}
        .muted{color:var(--muted)}

        /* Library */
        .search{width:100%;background:#0f0f13;border:1px solid var(--line);border-radius:12px;color:var(--fg);padding:10px 12px}
        .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
        .chip{font-size:12px;background:#1a1a21;border:1px dashed var(--line);padding:6px 10px;border-radius:999px}

        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #1c1c22}
        thead th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
        tbody tr{cursor:pointer}
        tbody tr:hover{background:#17171d}
        tbody tr.active{background:#1b1b22}
        .cover{width:28px;height:28px;border-radius:8px;background:#222;object-fit:cover}
        .list{max-height:50vh;overflow:auto;border:1px solid var(--line);border-radius:12px}

        /* Player */
        .player{display:grid;grid-template-columns:320px 1fr;gap:24px}
        @media (max-width:900px){.player{grid-template-columns:1fr}}
        .art{aspect-ratio:1/1;width:100%;border-radius:20px;overflow:hidden;background:#0d0d10;border:1px solid var(--line)}
        .progress{height:10px;background:#1a1a20;border-radius:999px;position:relative;cursor:pointer}
        .bar{position:absolute;left:0;top:0;bottom:0;border-radius:999px;background:linear-gradient(90deg,var(--fg),#ddd)}
        .knob{position:absolute;top:50%;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:50%;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.4);opacity:.0}
        .progress:hover .knob{opacity:1}
        .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .meta{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
        @media (max-width:900px){.meta{grid-template-columns:repeat(3,1fr)}}
        .tile{background:#121218;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center}
        .tile .k{font-size:11px;text-transform:uppercase;color:var(--muted);letter-spacing:.08em}
        .tile .v{font-weight:600}

        /* Drop zone (still shown as info but disabled) */
        .drop{border:1px dashed var(--line);border-radius:12px;padding:10px;text-align:center;color:var(--muted)}
        .drop.disabled{opacity:.6}

        .about{line-height:1.6;color:#d6d6db}
        kbd{background:#1b1b22;border:1px solid var(--line);border-bottom-color:#0c0c0f;padding:2px 6px;border-radius:6px;font-size:.9em}
    </style>
</head>
<body>
    <header>
        <div class="bar wrap">
            <div class="logo" aria-hidden="true"></div>
            <div style="font-weight:700; color:#777;">Eric Markievich · Demo Portfolio</div>
            <div class="spacer"></div>
            <div class="muted" style="font-size:10px">Loading songs from <code>frkatona.github.io</code></div>
        </div>
    </header>

    <main class="wrap">
        <aside>
            <div class="card pad" style="margin-bottom:16px">
                <div class="title" style="margin-bottom:8px">Search</div>
                <input id="search" class="search" type="text" placeholder="Title, artist, tag…" />
                <!-- <div class="chips" style="margin-top:12px">
                    <span class="chip">Loop: <span id="loopState">Off</span></span>
                    <button id="toggleLoop" class="btn" style="padding:6px 10px">Toggle L</button>
                    <span class="chip">Shuffle: <span id="shuffleState">Off</span></span>
                    <button id="toggleShuffle" class="btn" style="padding:6px 10px">Toggle S</button>
                </div> 
                <div id="drop" class="drop disabled" style="margin-top:12px">placeholder text 1</div>-->
            </div>

            <div class="card pad">
                <div class="row" style="justify-content:space-between;margin-bottom:8px">
                    <div class="title">Library <span class="muted" id="libCount">(0)</span></div>
                    <div class="muted" style="font-size:12px">Click a row to play</div>
                </div>
                <div class="list">
                    <table>
                        <thead>
                            <tr><th>#</th><th>Title</th><th>Artist</th><th>Lenth</th></tr>
                        </thead>
                        <tbody id="tbody"></tbody>
                    </table>
                </div>
            </div>
        </aside>

        <section>
            <div class="card pad">
                <div class="player">
                    <div>
                        <div class="art"><img id="cover" alt="cover" style="width:100%;height:100%;object-fit:cover;display:block"/></div>
                        <div id="tags" class="chips" style="margin-top:12px"></div>
                    </div>

                    <div>
                        <div style="margin-bottom:6px;font-size:26px;font-weight:700;letter-spacing:.2px" id="title">—</div>
                        <div class="muted" id="subtitle">—</div>

                        <div style="margin-top:16px">
                            <div id="progress" class="progress">
                                <div id="bar" class="bar" style="width:0%"></div>
                                <div id="knob" class="knob" style="left:0%"></div>
                            </div>
                            <div class="row" style="justify-content:space-between;margin-top:6px;font-size:12px">
                                <span id="timeCur">0:00</span>
                                <span id="timeLeft">-0:00</span>
                            </div>
                        </div>

                        <div class="row" style="margin-top:12px">
                            <button id="playPause" class="btn">Play</button>
                            <button id="prev" class="btn">Prev</button>
                            <button id="next" class="btn">Next</button>
                            <div class="row" style="margin-left:6px">
                                <span class="muted" style="font-size:12px">Vol</span>
                                <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9"/>
                            </div>
                            <label class="row" style="margin-left:6px;font-size:14px"><input id="loop" type="checkbox"/> Loop</label>
                            <label class="row" style="font-size:14px"><input id="shuffle" type="checkbox"/> Shuffle</label>
                        </div>

                        <div class="meta" style="margin-top:14px">
                            <div class="tile"><div class="k">BPM</div><div class="v" id="metaBpm">—</div></div>
                            <div class="tile"><div class="k">Key</div><div class="v" id="metaKey">—</div></div>
                            <div class="tile"><div class="k">Length</div><div class="v" id="metaLen">—</div></div>
                            <div class="tile"><div class="k">Index</div><div class="v" id="metaIdx">0/0</div></div>
                            <!-- <div class="tile"><div class="k">Rate</div><div class="v" id="metaRate">0%</div></div> 
                            <div class="tile"><div class="k">Theme</div><div class="v">dark</div></div> -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="card pad" style="margin-top:16px">
                <div class="title" style="margin-bottom:6px">Dev Notes</div>
                <p class="about">This build loads songs from the <code>./songs/</code> folder according to the <code>./songs/manifest.json</code> metadata file.  To-do: click through song progress, solve simplfied waveform to use as progress bar, fix key and tempo not appearing</p>
            </div>
        </section>
    </main>

    <audio id="audio" preload="metadata"></audio>

    <script>
    (function(){
        /** @typedef {{id:string,title:string,artist:string,album:string,src:string,cover?:string,tags?:string[],bpm?:number,key?:string,length?:string,year?:number}} Track */

        const $ = (id)=>document.getElementById(id);
        const els = {
            search: $('search'), tbody: $('tbody'), libCount: $('libCount'),
            playPause: $('playPause'), prev: $('prev'), next: $('next'), vol: $('vol'), loop: $('loop'), shuffle: $('shuffle'),
            loopState: $('loopState'), shuffleState: $('shuffleState'),
            title: $('title'), subtitle: $('subtitle'), cover: $('cover'), tags: $('tags'),
            progress: $('progress'), bar: $('bar'), knob: $('knob'), timeCur: $('timeCur'), timeLeft: $('timeLeft'),
            metaBpm: $('metaBpm'), metaKey: $('metaKey'), metaLen: $('metaLen'), metaIdx: $('metaIdx'), metaRate: $('metaRate'),
            audio: $('audio')
        };

        let library = [];
        let filtered = [];
        let currentIndex = 0;
        let isPlaying = false;
        let loop = false;
        let shuffle = false;

        const fmt = (s)=>{
            if (!Number.isFinite(s)) return '0:00';
            const m = Math.floor(s/60);
            const ss = Math.floor(s%60).toString().padStart(2,'0');
            return m+':'+ss;
        };

        function calcDurationMeta(audioEl, track){
            const d = audioEl.duration;
            if (Number.isFinite(d)) {
                track.length = fmt(d);
            }
        }

        function setLibrary(newItems){
            // replace library with items from server (prepend kept for compatibility; library empty initially)
            library = newItems.concat(library);
            filter();
            if (library.length && !els.audio.src){ selectTrack(0,false); }
        }

        function filter(){
            const q = els.search.value.trim().toLowerCase();
            filtered = !q? library : library.filter(t => (t.title+" "+t.artist+" "+t.album+" "+(t.tags||[]).join(' ')).toLowerCase().includes(q));
            renderTable();
        }

        function renderTable(){
            els.libCount.textContent = '('+filtered.length+')';
            els.tbody.innerHTML = '';
            filtered.forEach((t, i)=>{
                const realIdx = library.findIndex(x=>x.id===t.id);
                const tr = document.createElement('tr');
                if (realIdx === currentIndex) tr.classList.add('active');
                tr.innerHTML = `
                    <td style="width:36px">${realIdx+1}</td>
                    <td>
                        <div style="display:flex;align-items:center;gap:8px">
                            <div class="cover" style="background:${coverBg(t)}"></div>
                            <div>
                                <div style="font-weight:600">${escapeHtml(t.title)}</div>
                                <div class="muted" style="font-size:12px">${escapeHtml(t.album||'')}</div>
                            </div>
                        </div>
                    </td>
                    <td>${escapeHtml(t.artist||'')}</td>
                    <td style="text-align:right">${t.length||'—'}</td>`;
                tr.addEventListener('click',()=>{
                    playByIndex(realIdx);
                });
                els.tbody.appendChild(tr);
            });
        }

        function coverBg(t){
            const hash = (t.title||'').split('').reduce((a,c)=>((a<<5)-a+c.charCodeAt(0))|0,0);
            const h1 = (hash % 360 + 360) % 360;
            const h2 = (h1+60)%360;
            return `linear-gradient(135deg, hsl(${h1} 60% 45%), hsl(${h2} 70% 35%))`;
        }

        function selectTrack(idx, autoplay){
            if (!library.length) return;
            currentIndex = ((idx%library.length)+library.length)%library.length;
            const t = library[currentIndex];
            els.audio.src = t.src;
            els.title.textContent = t.title || '—';
            els.subtitle.textContent = `${t.artist||'—'} · ${t.album||''} ${t.year? '· '+t.year: ''}`;
            els.cover.src = '';
            els.cover.style.background = coverBg(t);
            els.tags.innerHTML = (t.tags||[]).map(tag=>`<span class="chip">${escapeHtml(tag)}</span>`).join('');
            els.metaBpm.textContent = t.bpm ?? '—';
            els.metaKey.textContent = t.key ?? '—';
            els.metaLen.textContent = t.length ?? '—';
            els.metaIdx.textContent = `${currentIndex+1}/${library.length}`;
            updateProgressUI();
            renderTable();
            if (autoplay){ play(); }
        }

        function playByIndex(idx){ selectTrack(idx,true); }

        function play(){ isPlaying = true; els.playPause.textContent = 'Pause'; els.audio.play().catch(()=>{}); }
        function pause(){ isPlaying = false; els.playPause.textContent = 'Play'; els.audio.pause(); }
        function prev(){ if (shuffle) { playByIndex(randIndex()); } else { playByIndex(currentIndex-1); } }
        function next(){ if (shuffle) { playByIndex(randIndex()); } else { playByIndex(currentIndex+1); } }
        function randIndex(){ return Math.floor(Math.random()*library.length); }

        function seekTo(seconds){ if (!Number.isFinite(seconds)) return; els.audio.currentTime = Math.max(0, Math.min(seconds, els.audio.duration||0)); }
        function seekBy(dt){ seekTo((els.audio.currentTime||0)+dt); }

        function updateProgressUI(){
            const cur = els.audio.currentTime||0;
            const dur = els.audio.duration||0;
            const pct = dur? (cur/dur)*100: 0;
            els.bar.style.width = pct+'%';
            els.knob.style.left = pct+'%';
            els.timeCur.textContent = fmt(cur);
            els.timeLeft.textContent = '-' + fmt(Math.max(0, dur-cur));
            els.metaRate.textContent = Math.round(pct)+'%';
        }

        // Events — audio
        els.audio.addEventListener('timeupdate', updateProgressUI);
        els.audio.addEventListener('loadedmetadata', ()=>{
            const t = library[currentIndex];
            if (t){ calcDurationMeta(els.audio, t); els.metaLen.textContent = t.length || '—'; renderTable(); }
            updateProgressUI();
        });
        els.audio.addEventListener('ended', ()=>{
            if (loop){ seekTo(0); play(); } else { next(); }
        });

        // Controls
        els.playPause.addEventListener('click', ()=> isPlaying? pause(): play());
        els.prev.addEventListener('click', prev);
        els.next.addEventListener('click', next);
        els.vol.addEventListener('input', ()=>{ els.audio.volume = parseFloat(els.vol.value || '0.9'); });
        els.loop.addEventListener('change', ()=>{ loop = els.loop.checked; els.loopState.textContent = loop? 'On':'Off'; });
        els.shuffle.addEventListener('change', ()=>{ shuffle = els.shuffle.checked; els.shuffleState.textContent = shuffle? 'On':'Off'; });

        // Keyboard
        window.addEventListener('keydown', (e)=>{
            const tag = (e.target && e.target.tagName)||'';
            if (tag === 'INPUT' || tag === 'TEXTAREA') return;
            if (e.code === 'Space'){ e.preventDefault(); isPlaying? pause() : play(); }
            else if (e.code === 'ArrowRight'){ seekBy(5); }
            else if (e.code === 'ArrowLeft'){ seekBy(-5); }
            else if (e.key && e.key.toLowerCase() === 'l'){ loop = !loop; els.loop.checked = loop; els.loopState.textContent = loop? 'On':'Off'; }
            else if (e.key && e.key.toLowerCase() === 's'){ shuffle = !shuffle; els.shuffle.checked = shuffle; els.shuffleState.textContent = shuffle? 'On':'Off'; }
        });

        // Search
        els.search.addEventListener('input', filter);

    // --- New: load songs from page-relative ./songs/ folder ---
        async function loadSongsFromFolder(){
            const base = './songs/';
            try {
                // Try manifest first (recommended). manifest.json should be an array of objects: { file: "track.mp3", title?: "...", artist?: "...", album?: "..."}
                const mResp = await fetch(base + 'manifest.json', { cache: 'no-cache' });
                if (mResp.ok){
                    const manifest = await mResp.json();
                    const items = manifest.map((entry, idx)=> {
                        const fname = entry.file || entry.filename || entry.path;
                        return {
                            id: 'remote-'+(entry.id||fname||idx),
                            title: entry.title || (fname? fname.replace(/\.[^.]+$/,'') : 'track'),
                            artist: entry.artist || '',
                            album: entry.album || '',
                            src: base + fname,
                            tags: entry.tags || ['remote'],
                            year: entry.year
                        };
                    });
                    setLibrary(items);
                    prefetchDurations(items);
                    return;
                }
            } catch (err){
                // manifest not found or invalid — fall through to directory listing attempt
            }

            // Fallback: try to fetch directory listing HTML and parse links
            try {
                const resp = await fetch(base, { cache: 'no-cache' });
                if (!resp.ok) throw new Error('dir fetch failed');
                const txt = await resp.text();
                // Parse any anchor hrefs ending with common audio extensions
                const doc = new DOMParser().parseFromString(txt, 'text/html');
                const anchors = Array.from(doc.querySelectorAll('a'));
                const audioFiles = anchors.map(a=> a.getAttribute('href')).filter(h => h && /\.(mp3|ogg|wav|m4a|flac)$/i.test(h));
                const unique = Array.from(new Set(audioFiles));
                if (unique.length){
                    const items = unique.map((fname, idx)=>({
                        id: 'remote-'+fname,
                        title: fname.replace(/^.*[\/\\]/,'').replace(/\.[^.]+$/,''),
                        artist: '',
                        album: '',
                        src: (fname.startsWith('http')||fname.startsWith('/'))? fname : base + fname,
                        tags: ['remote']
                    }));
                    setLibrary(items);
                    prefetchDurations(items);
                    return;
                }
            } catch (err){
                // nothing else to do
            }

            // If we get here, no songs found
            console.warn(`No songs found in ${base}. Provide ${base}manifest.json or enable directory listing for ${base}.`);
            els.subtitle.textContent = `No songs found in ${base}`;
        }

        // Optional: prefetch metadata (duration) for listing display
        function prefetchDurations(items){
            items.forEach(item=>{
                try {
                    const a = new Audio();
                    a.preload = 'metadata';
                    a.src = item.src;
                    a.addEventListener('loadedmetadata', ()=>{
                        item.length = fmt(a.duration);
                        renderTable();
                        // release src to avoid keeping many decoders open
                        a.src = '';
                    }, { once: true });
                    // don't attach error handlers here — skip silently on CORS or 404
                } catch(e){}
            });
        }

    // Initialize: load songs from page-relative ./songs/ on page load
    loadSongsFromFolder();

    // Initialize with nothing; show hints in UI
    els.subtitle.textContent = 'frkatona.github.io';
    })();
    // tiny util to escape text into HTML
    function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
    </script>
</body>
</html>
